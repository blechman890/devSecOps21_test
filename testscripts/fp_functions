#!/bin/bash

# ==============================
#  CONFIGURATION
# ==============================
SYSLOG_PATTERN="/var/log/syslog*"
CONFIG_FILE="error_keywords.conf"

# ==============================
#  FUNCTION: Print error and exit
# ==============================
error_exit() {
    local message="$1"
    local exit_code="${2:-1}"  # Default exit code is 1
    echo "Error: $message" >&2
    exit "$exit_code"
}

# ==============================
#  FUNCTION: Validate config file
# ==============================
validate_config() {
    [[ -f "$CONFIG_FILE" ]] || error_exit "Config file '$CONFIG_FILE' not found."
}

# ==============================
#  FUNCTION: Load patterns from config
# ==============================
load_patterns() {
    local -n patterns=$1  # Name reference to array
    
    mapfile -t patterns < <(grep -v '^#\|^$' "$CONFIG_FILE")
    
    [[ ${#patterns[@]} -eq 0 ]] && error_exit "No valid patterns in '$CONFIG_FILE'."
    
    echo "Loaded ${#patterns[@]} patterns from config"
}

# ==============================
#  FUNCTION: Validate syslog files
# ==============================
validate_syslog_files() {
    ls $SYSLOG_PATTERN &>/dev/null || error_exit "Syslog files not found matching: $SYSLOG_PATTERN"
    
    for log in $SYSLOG_PATTERN; do
        [[ -r "$log" ]] || error_exit "No read permission on $log"
    done
    
    echo "Syslog files validated"
}

# ==============================
#  FUNCTION: Create report filename
# ==============================
create_report_filename() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    echo "syslog_report_${timestamp}.txt"
}

# ==============================
#  FUNCTION: Write report header
# ==============================
write_report_header() {
    local report_file="$1"
    
    cat >> "$report_file" << EOF
==========================================
LOG ANALYSIS REPORT - $(date +%Y%m%d_%H%M%S)
Initiated by: $(whoami)
==========================================

EOF
}

# ==============================
#  FUNCTION: Extract IPs from log
# ==============================
extract_ips() {
    local pattern="$1"
    local log_file="$2"
    
    grep -Ei "$pattern" "$log_file" | \
        grep -Eo "([0-9]{1,3}\.){3}[0-9]{1,3}" | \
        sort | uniq -c | sort -nr
}

# ==============================
#  FUNCTION: Format pattern results
# ==============================
format_pattern_results() {
    local pattern="$1"
    local ips="$2"
    
    if [[ -n "$ips" ]]; then
        while read count ip; do
            echo " • '$pattern' → $count × $ip"
        done <<< "$ips"
    else
        echo " • '$pattern' → 0 matches"
    fi
}

# ==============================
#  FUNCTION: Process single log file
# ==============================
process_log_file() {
    local log="$1"
    local -n patterns_ref=$2  # Name reference to patterns array
    local report_file="$3"
    
    # Validate file
    [[ -f "$log" && -r "$log" ]] || return 1
    
    # Write log section header
    echo -e "\n========== $log ==========" >> "$report_file"
    
    # Process each pattern
    for pattern in "${patterns_ref[@]}"; do
        local ips=$(extract_ips "$pattern" "$log")
        format_pattern_results "$pattern" "$ips" >> "$report_file"
    done
    
    return 0
}

# ==============================
#  FUNCTION: Process all logs
# ==============================
process_all_logs() {
    local -n patterns_ref=$1
    local report_file="$2"
    local logcount=0
    
    for log in $SYSLOG_PATTERN; do
        if process_log_file "$log" patterns_ref "$report_file"; then
            ((logcount++))
            echo "Processed: $log"
        fi
    done
    
    echo "$logcount"  # Return count
}

# ==============================
#  FUNCTION: Write report summary
# ==============================
write_report_summary() {
    local report_file="$1"
    local logcount="$2"
    local pattern_count="$3"
    
    cat >> "$report_file" << EOF

==========================================
SUMMARY: $logcount files, $pattern_count patterns
==========================================
EOF
}

# ==============================
#  MAIN EXECUTION
# ==============================
main() {
    echo "Starting syslog analysis..."
    
    # Step 1: Validate configuration
    validate_config
    
    # Step 2: Load patterns
    declare -a ERROR_PATTERNS
    load_patterns ERROR_PATTERNS
    
    # Step 3: Validate syslog files
    validate_syslog_files
    
    # Step 4: Create report
    local report=$(create_report_filename)
    
    # Step 5: Write header
    write_report_header "$report"
    
    # Step 6: Process all logs
    local logcount=$(process_all_logs ERROR_PATTERNS "$report")
    
    # Step 7: Write summary
    write_report_summary "$report" "$logcount" "${#ERROR_PATTERNS[@]}"
    
    # Step 8: Notify user
    echo ""
    echo "✓ Analysis complete!"
    echo "Report saved to: $report"
}

# Run main function
main
