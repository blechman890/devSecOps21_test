#!/bin/bash

set -x  # Debug mode for development; remove or comment out in production

# ==============================
#  CONFIGURATION
# ==============================
SYSLOG_PATTERN="/var/log/syslog*"
CONFIG_FILE="error_keywords.conf"

# ==============================
#  CHECK CONFIG FILE
# ==============================
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Configuration file '$CONFIG_FILE' not found."
    exit 1
fi

# ==============================
#  LOAD PATTERNS SAFELY
# ==============================
ERROR_PATTERNS=()
while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    ERROR_PATTERNS+=("$line")
done < "$CONFIG_FILE"

# Validate patterns
if [[ ${#ERROR_PATTERNS[@]} -eq 0 ]]; then
    echo "Error: No valid patterns found in '$CONFIG_FILE'."
    exit 1
fi

# ==============================
#  CHECK SYSLOG FILES
# ==============================
if ! ls "$SYSLOG_PATTERN" &>/dev/null; then
    echo "Syslog files not found matching pattern: $SYSLOG_PATTERN"
    exit 1
fi

for log in $SYSLOG_PATTERN; do
    if [[ ! -r "$log" ]]; then
        echo "Don't have read permissions on $log"
        exit 1
    fi
done

# ==============================
#  REPORT SETUP
# ==============================
timestamp=$(date +"%Y%m%d_%H%M%S")
epoch=$(date +%s)
report="syslog_report_${timestamp}.txt"
initiator=$(whoami)

{
    echo "=========================================="
    echo "          LOG ANALYSIS REPORT"
    echo "=========================================="
    echo " Source Log Pattern : $SYSLOG_PATTERN"
    echo " Generated At        : $timestamp"
    echo " Epoch Time          : $epoch"
    echo " Initiated By        : $initiator"
    echo "=========================================="
    echo ""
} > "$report"

# ==============================
#  PROCESS LOG FILES
# ==============================
logcount=0

for log in $SYSLOG_PATTERN; do
    if [[ -f "$log" && -r "$log" ]]; then

        ((logcount++))

        echo "Processing $log"

        {
            echo "=========================================="
            echo " ANALYSIS FOR LOG FILE: $log"
            echo "=========================================="
            echo ""
            echo "---------- Pattern Match Results ----------"
        } >> "$report"

        for pattern in "${ERROR_PATTERNS[@]}"; do
            matches=$(grep -Ei "$pattern" "$log" | grep -Eo "([0-9]{1,3}\.){3}[0-9]{1,3}")

            if [[ -n "$matches" ]]; then
                # Count occurrences of each IP address
                ip_counts=$(echo "$matches" | sort | uniq -c | sort -nr)

                while IFS= read -r line; do
                    echo " • '$pattern' → $line matches" >> "$report"
                done <<< "$ip_counts"
            else
                echo " • '$pattern' → 0 matches (no IPs found)" >> "$report"
            fi
        done

        echo "" >> "$report"
    fi
done

# ==============================
#  SUMMARY
# ==============================
{
    echo "=========================================="
    echo "                  SUMMARY"
    echo "=========================================="
    echo " Total Log Files Analyzed : $logcount"
    echo " Total Patterns Loaded    : ${#ERROR_PATTERNS[@]}"
    echo " Report File              : $report"
    echo "=========================================="
} >> "$report"

echo "Report saved to: $report"
